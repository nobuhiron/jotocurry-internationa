---
import SectionTitle from '../components/SectionTitle.astro';
import ContactButton from '../components/ContactButton.astro';
import { getFaqs } from '../lib/microcms-faq';
import { getLocalizedFaq } from '../lib/i18n';
import { translations } from '../data/translations';
import type { Locale } from '../lib/i18n';

interface Props {
  locale?: Locale;
}

const { locale = 'ja' } = Astro.props;
const faqText = translations.contact.faq[locale];

// microCMSからFAQを取得
// フィールド: order, questionJa, answerJa, questionEn, answerEn
let faqData: Array<{ question: string; answer: string }> = [];
try {
  console.log('[FAQ] locale=', locale);
  console.log('[FAQ] domain=', import.meta.env.MICROCMS_SERVICE_DOMAIN);
  console.log('[FAQ] key length=', (import.meta.env.MICROCMS_API_KEY ?? '').length);
  const faqs = await getFaqs(locale);
  // orderフィールドでソート（既にAPI側でソートされているが、念のため）
  const sortedFaqs = [...faqs].sort((a, b) => (a.order || 0) - (b.order || 0));
  // 言語に応じて質問と回答を出し分け
  faqData = sortedFaqs.map((faq) => getLocalizedFaq(faq, locale));
} catch (error) {
  // microCMSが設定されていない場合のフォールバック
  console.warn('microCMSからFAQを取得できませんでした。フォールバックデータを使用します。', error);
  // フォールバック: 空の配列
  faqData = [];
}
---

<section class="p-contact-faq l-section" data-bg="alt">
  <div class="l-container">
    <div class="p-contact-faq__inner l-section__inner" data-gap="4xl">
      <SectionTitle
        title={faqText.title}
        subtitle={faqText.subtitle}
        class="p-contact-faq__title"
      />

      <div class="p-contact-faq__list">
        {faqData.map((faq, index) => {
          const itemId = `faq-item-${index}`;
          const contentId = `faq-content-${index}`;
          const isFirst = index === 0;
          return (
            <div class={`p-contact-faq__item ${isFirst ? 'is-open' : ''}`} id={itemId}>
              <button
                type="button"
                class="p-contact-faq__button"
                id={`faq-button-${index}`}
                aria-expanded={isFirst ? 'true' : 'false'}
                aria-controls={contentId}
              >
                <span class="p-contact-faq__question">{faq.question}</span>
                <span class="p-contact-faq__icon" aria-hidden="true">
                  <span class="p-contact-faq__icon-plus">+</span>
                  <span class="p-contact-faq__icon-close">×</span>
                </span>
              </button>
              <div
                id={contentId}
                class="p-contact-faq__content"
                aria-labelledby={`faq-button-${index}`}
              >
                <p class="p-contact-faq__answer">{faq.answer}</p>
              </div>
            </div>
          );
        })}
      </div>

      <div class="p-contact-faq__cta">
        <h3 class="p-contact-faq__cta-title">{faqText.cta.title}</h3>
        <p class="p-contact-faq__cta-text">{faqText.cta.text}</p>
        <div class="p-contact-faq__cta-button">
          <ContactButton text={faqText.cta.button} href="#contact-form" />
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import initContactFaq from '../scripts/contact-faq.js';

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initContactFaq);
  } else {
    initContactFaq();
  }
</script>

